const nodemailer = require("nodemailer");

exports.handler = async (event) => {
  try {
    if (event.httpMethod === "OPTIONS") {
      return {
        statusCode: 200,
        headers: corsHeaders(),
        body: ""
      };
    }

    if (event.httpMethod !== "POST") {
      return {
        statusCode: 405,
        headers: corsHeaders(),
        body: "Method Not Allowed"
      };
    }

    const {
      fullName,
      email,
      phone,
      preferredContact,
      businessName,
      industry,
      hasWebsite,
      monthlyVisitorsOrLeads,
      serviceInterest,
      budgetRange,
      timeline,
      summary
    } = JSON.parse(event.body || "{}");

    // Basic guard
    if (!fullName && !businessName && !phone && !email) {
      return {
        statusCode: 400,
        headers: corsHeaders(),
        body: JSON.stringify({ ok: false, error: "Missing lead fields" })
      };
    }

    const transporter = nodemailer.createTransport({
      host: process.env.EMAIL_HOST,
      port: Number(process.env.EMAIL_PORT || 587),
      secure: false, // STARTTLS
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS
      }
    });

    const to = process.env.EMAIL_TO;
    const from = process.env.EMAIL_FROM || process.env.EMAIL_USER;

    const subject = `New website lead: ${fullName || businessName || "Unknown"}`;

    const text =
`New Lead Received

Name: ${fullName || ""}
Business: ${businessName || ""}
Preferred contact: ${preferredContact || ""}
Email: ${email || ""}
Phone: ${phone || ""}

Industry: ${industry || ""}
Has website: ${hasWebsite || ""}
Monthly visitors/leads: ${monthlyVisitorsOrLeads || ""}

Service interest: ${serviceInterest || ""}
Budget range: ${budgetRange || ""}
Timeline: ${timeline || ""}

Summary:
${summary || ""}

(Generated by Netlify Function)
`;

    await transporter.sendMail({ from, to, subject, text });

    return {
      statusCode: 200,
      headers: corsHeaders(),
      body: JSON.stringify({ ok: true })
    };
  } catch (err) {
    return {
      statusCode: 500,
      headers: corsHeaders(),
      body: JSON.stringify({ ok: false, error: String(err) })
    };
  }
};

function corsHeaders() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Headers": "Content-Type",
    "Access-Control-Allow-Methods": "POST, OPTIONS"
  };
}

